/**
 * Record timestamps
 */

function timestamps(schema, options) {
  if (!schema._fields.createdAt) {
    schema._fields.createdAt = schema.types.string().isodate().optional();
  }
  
  if (!schema._fields.updatedAt) {
    schema._fields.updatedAt = schema.types.string().isodate().optional();
  }
  
  schema.before('create', function(record, done) {
    var now = (new Date).toISOString();
    record.createdAt = now;
    record.updatedAt = now;
    done();
  });

  schema.before('update', function(record, done) {
    record.updatedAt = (new Date).toISOString();
    done();
  });
}

/**
 * Install plugin
 */

function installPlugin(schema) {
  schema.use(timestamps);
}

/**
 * Expose Rethink plugin
 */

exports = module.exports = function(rethink) {
  rethink.before('buildSchema', installPlugin);
}

/**
 * Expose schema plugin
 */

exports.timestamps = installPlugin;